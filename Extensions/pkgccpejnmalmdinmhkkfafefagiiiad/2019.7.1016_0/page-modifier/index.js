let editor=null;new Vue({el:"#pageContainer",data:{editing:!1,editCM:{},unSavedCMID:0,cachedModifiers:[]},mounted:function(){this.editCM=this.getANewCM(),editor=CodeMirror.fromTextArea(this.$refs.mScript,{mode:"text/javascript",lineNumbers:!0,matchBrackets:!0,styleActiveLine:!0,lineWrapping:!0}),window.onbeforeunload=function(e){this.editing&&((e||window.event).returnValue="当前还有未保存的数据，确定要离开么？")},chrome.runtime.sendMessage({type:MSG_TYPE.GET_PAGE_MODIFIER_CONFIG},e=>{this.cachedModifiers=e||[]})},methods:{getANewCM:function(){return{mName:"",mPattern:"",mFilter:"0",mScript:"",mRefresh:0,mDisabled:null}},createModifier:function(){if(this.editing)return alert("当前还有未保存的数据，无法继续创建！");this.editing=!0,this.editCM=this.getANewCM(),this.editCM.id="mf_"+1*new Date,this.cachedModifiers.push(this.editCM),this.$refs.mForm.reset(),$(".m-mask").slideUp(),$(".m-form").removeClass("x-masked")},selectModifier:function(e){if(this.editing){if(!confirm("当前还有未保存的数据，确定不要这个数据了吗？"))return!1;this.editing=!1,this.cachedModifiers.pop()}if(this.editCM.id===e.id)return!1;this.editCM=e,editor.setValue(e.mScript),$(".m-mask").slideUp(),$(".m-form").removeClass("x-masked")},saveModifier:function(e){if(e){if(!this.editCM.mName||!this.editCM.mName.trim())return alert("网页精灵名称 不能为空，起一个自己看得懂的名字吧！"),!1;let e=this.editCM.mPattern.trim().match(/\/(.*)\/([igm]*)?$/);if(!e||!e.length)return alert("网页匹配规则 必须是一个正确的Javascript正则表达式！"),!1;this.editCM.mScript=editor.getValue(),this.cachedModifiers.some(e=>{if(e.id===this.editCM.id)return e.mName=this.editCM.mName.trim(),e.mPattern=this.editCM.mPattern.trim(),e.mFilter=this.editCM.mFilter,e.mRefresh=this.editCM.mRefresh,e.mScript=editor.getValue(),e.mDisabled=!!e.mDisabled,!0})}chrome.runtime.sendMessage({type:MSG_TYPE.SAVE_PAGE_MODIFIER_CONFIG,params:this.cachedModifiers},()=>{alert("数据操作成功！"),this.editCM=this.getANewCM(),editor.setValue(""),this.editing=!1,this.$refs.mForm.reset(),$(".m-mask").slideDown(),$(".m-form").addClass("x-masked")})},importModifier:function(){let e=this,i=document.getElementById("fileInput");i||((i=document.createElement("input")).id="fileInput",i.type="file",i.accept="application/json",i.style.cssText="position:relative;top:-1000px;left:-1000px;",i.onchange=function(t){let r=new FileReader;r.readAsText(i.files[0],"utf-8"),r.onload=(i=>{let t=i.target.result;try{let i=JSON.parse(t.replace(/^\/\*[^\*]*\*\//,""));if(i&&Array.isArray(i)&&i.length){let t="id,mName,mPattern,mFilter,mRefresh,mScript,mDisabled".split(","),r=i.filter(e=>!("object"!=typeof e||(Object.keys(e).forEach(i=>{!t.includes(i)&&delete e[i]}),!Object.keys(e).length)));if(r.length){let i=null;return r.forEach(r=>{e.cachedModifiers.some(e=>{if(r.id===e.id||r.mName===e.mName||r.mPattern===e.mPattern)return null===i&&(i=confirm("发现有相同名称或规则的精灵，是否选择覆盖？")),i?t.forEach(i=>{e[i]=r[i]}):r.id+="_",i})||e.cachedModifiers.push(r)}),e.saveModifier()}}throw new Error}catch(e){alert("当前选择的JSON配置文件格式不正确！")}})},document.body.appendChild(i)),i.click()},exportModifier:function(){chrome.runtime.sendMessage({type:MSG_TYPE.GET_PAGE_MODIFIER_CONFIG},e=>{if(e&&e.length){let i=1*new Date,t="/* Page modifier config, exported from FeHelper, timestamp:"+i+" */\n\n",r=JSON.stringify(e,null,4),s=new Blob([t+r],{type:"application/octet-stream"});chrome.permissions.request({permissions:["downloads"]},e=>{e?chrome.downloads.download({url:URL.createObjectURL(s),saveAs:!0,conflictAction:"overwrite",filename:"FeHelper-PM-"+i+".json"},()=>{alert("数据导出成功！")}):alert("必须接受授权，才能正常导出！")})}else alert("没有已保存/可使用的精灵，不可导出！")})},removeModifier:function(e){confirm("你确定要删除所有的精灵吗，此操作不可撤销！")&&(this.cachedModifiers=e?this.cachedModifiers.filter(i=>i.id!==e.id):[],this.saveModifier())},disableModifier:function(e){e?confirm("请再次确认是否需要"+(e.mDisabled?"启用":"停用")+"此精灵？")&&(this.editCM.mDisabled=!e.mDisabled,this.saveModifier(!0)):confirm("停用精灵后，可单独编辑启用；是否继续此操作？")&&(this.cachedModifiers.forEach(e=>{e.mDisabled=!0}),this.saveModifier())}}});